<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for access/ERC20Burner.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">access/</a> ERC20Burner.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">75% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>30/40</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">50% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>15/30</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">55.56% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>5/9</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">72.22% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>39/54</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">37×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33×</span>
<span class="cline-any cline-yes">27×</span>
<span class="cline-any cline-yes">26×</span>
<span class="cline-any cline-yes">24×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.4.24;
&nbsp;
import "../math/SafeMath.sol";
import "../interfaces/ERC20.sol";
&nbsp;
interface BurnToken {
  function decimals() external view returns (uint8);
  function balanceOf(address _who) external view returns (uint256);
  function burn(uint _amount) external returns (bool success);
  function burnFrom(address _from, uint _amount) external returns (bool success);
}
interface LogTransaction {  function transaction(string _message, address _from, address _to, uint _amount, bytes32 _id)  external; }
interface DB {
  function addressStorage(bytes32 _key) external view returns (address);
  function bytes32Storage(bytes32 _key) external view returns (bytes32);
  function boolStorage(bytes32 _key) external view returns (bool);
  function setUint(bytes32 _key, uint _value) external;
}
&nbsp;
interface ERC20Burner_KyberProxy{
  function getExpectedRate(address src, address dest, uint srcQty) external view returns (uint expectedRate, uint slippageRate);
  function trade(address src, uint srcAmount, address dest, address destAddress, uint maxDestAmount,uint minConversionRate, address walletId) external payable returns(uint);
}
&nbsp;
/// @title A contract for burning ERC20 tokens as usage fee for dapps
/// @author Kyle Dewhurst &amp; Peter Phillips MyBit Foundation
/// @notice Allows Dapps to call this contract to burn ERC20 tokens as a usage fee
/// @dev This contract does not accept tokens. It only burns tokens from investors wallets to run platform functionality
contract ERC20Burner {
  using SafeMath for uint256;
&nbsp;
  BurnToken public token;  // The instance of the ERC20 burner contract
  DB public database;   // The datbase instance
  LogTransaction public events; //LogTransaction contract
  ERC20Burner_KyberProxy kyber;
  uint256 decimals;
&nbsp;
  // @notice constructor: initializes database and the MYB token
  // @param: the address for the database contract used by this platform
  constructor(address _database, address _events, address _kyber)
  public {
    database = DB(_database);
    events = LogTransaction(_events);
    token = BurnToken(database.addressStorage(keccak256(abi.encodePacked("platform.token"))));
    <span class="missing-if-branch" title="else path not taken" >E</span>require(address(token) != address(0));
    kyber = ERC20Burner_KyberProxy(_kyber);
    uint dec = token.decimals();
    decimals = 10**dec;
  }
&nbsp;
  // @notice authorized contracts can burn mybit tokens here if the investor has approved this contract to do so
  // @param (address) _tokenHolder = the address of the mybit token holder who wishes to burn _amount of tokens
  // @param (uint) _amount = the amount of tokens to be burnt (must include decimal places)
  function burn(address _tokenHolder, uint _amount, address _burnToken)
  payable
  external
  returns (bool) {
    //onlyPlatformContracts:
    require(database.boolStorage(keccak256(abi.encodePacked("contract", msg.sender))));
    //acceptedState:
    require(database.boolStorage(keccak256(abi.encodePacked(database.bytes32Storage(keccak256(abi.encodePacked("currentState"))), _tokenHolder))) || database.boolStorage(keccak256(abi.encodePacked("ignoreStateChanges", _tokenHolder))));
    if(_burnToken == address(token)){
      require(token.burnFrom(_tokenHolder, _amount));
      events.transaction('Platform Token Burnt', _tokenHolder, msg.sender, _amount, '');
    } else {
      //Calculate the estimate cost of given ERC20 to get convert to correct amount of platform token
      (uint expectedRate, uint minRate) = kyber.getExpectedRate(_burnToken, address(token), 0);
      uint estimatedCost = expectedRate.mul(_amount).div(decimals);
      <span class="missing-if-branch" title="if path not taken" >I</span>if(_burnToken == address(0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE)){
        //Ether was chosen as the burn token
<span class="cstat-no" title="statement not covered" >        require(msg.value &gt;= estimatedCost, 'Not enough funds')</span>;
<span class="cstat-no" title="statement not covered" >        convert(_tokenHolder, _burnToken, address(token), msg.value, _amount, minRate, true)</span>;
      } else {
        ERC20 burnToken = ERC20(_burnToken);
        //Transfer burn token from the user
        <span class="missing-if-branch" title="else path not taken" >E</span>require(burnToken.transferFrom(_tokenHolder, address(this), estimatedCost));
        // Mitigate ERC20 Approve front-running attack, by initially setting
        // allowance to 0
        <span class="missing-if-branch" title="else path not taken" >E</span>require(burnToken.approve(address(kyber), 0));
        // Approve tokens so network can take them during the swap
        burnToken.approve(address(kyber), estimatedCost);
        convert(_tokenHolder, _burnToken, address(token), estimatedCost, _amount, minRate, false);
      }
      //Get amount of the platform token held by this contract (in case it differs from the _amount parameter)
      uint amount = token.balanceOf(this);
      //Burn the platform token
      <span class="missing-if-branch" title="else path not taken" >E</span>require(token.burn(amount));
      events.transaction('Platform Token Burnt', _tokenHolder, msg.sender, amount, '');
&nbsp;
    }
    return true;
  }
&nbsp;
  function convert(address _user, address _from, address _to, uint _amount, uint _max, uint _minRate, bool _eth)
  private
  returns (uint){
    uint balanceBefore;
    uint change;
    emit Trade(_from, _amount, _to, address(this), _max, _minRate, address(0));
    <span class="missing-if-branch" title="if path not taken" >I</span>if(_eth == true){
<span class="cstat-no" title="statement not covered" >      require(_amount &lt;= address(this).balance, "Not enough funds in contract")</span>;
<span class="cstat-no" title="statement not covered" >      balanceBefore = address(this).balance</span>;
      kyber.trade.value(_amount)(_from, _amount, _to, address(this), _max, _minRate, 0);
<span class="cstat-no" title="statement not covered" >      change = _amount.sub(balanceBefore.sub(address(this).balance))</span>;
      _user.transfer(change);
    } else {
      ERC20 erc20 = ERC20(_from);
      balanceBefore = erc20.balanceOf(this);
      kyber.trade(_from, _amount, _to, address(this), _max, _minRate, 0);
      change = _amount.sub(balanceBefore.sub(erc20.balanceOf(this)));
      erc20.transfer(_user, change);
    }
    return change;
  }
&nbsp;
  // @notice owners can set the cost of functionality on the platform here.
  // @dev _amount will be how many platformTokens are burned to call the method at _contractAddress
  // @param (bytes4) _methodID: the methodID of the function which is to require a burning fee
  // @param (address) _contractAddress: the address of the contract where this method is contained
  function setFee(bytes4 _methodID, address _contractAddress, uint _amount)
  external
  onlyOwner
  returns (bool) {
    //Sets the price to burn per function in MyB.
    database.setUint(keccak256(abi.encodePacked(_methodID, _contractAddress)), _amount);
    emit LogFeeAdded(_contractAddress, _methodID, _amount);
    return true;
  }
&nbsp;
  // @notice platform owners can destroy contract here
<span class="fstat-no" title="function not covered" >  function destroy()</span>
  onlyOwner
  external {
    events.transaction('ERC20Burner destroyed', address(this), msg.sender, address(this).balance, '');
<span class="cstat-no" title="statement not covered" >    selfdestruct(msg.sender)</span>;
  }
&nbsp;
  // @notice fallback function. We need to receive Ether from Kyber Network
<span class="fstat-no" title="function not covered" >  function ()</span>
  external
  payable {
<span class="cstat-no" title="statement not covered" >    emit EtherReceived(msg.sender, msg.value);</span>
  }
&nbsp;
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  //                                            Modifiers
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////
&nbsp;
  // @notice reverts if msg.sender isn't the owner
  modifier onlyOwner {
    <span class="missing-if-branch" title="else path not taken" >E</span>require(database.boolStorage(keccak256(abi.encodePacked("owner", msg.sender))));
    _;
  }
&nbsp;
  // @notice reverts if address isn't authorized to burn MYB
<span class="fstat-no" title="function not covered" >  modifier onlyPlatformContracts(address _burner) </span>{
<span class="cstat-no" title="statement not covered" >    require(database.boolStorage(keccak256(abi.encodePacked("contract", _burner))))</span>;
    _;
  }
&nbsp;
  // @notice reverts if investor hasn't accepted current contract state or if he doesn't ignore state changes entirely
<span class="fstat-no" title="function not covered" >  modifier acceptedState(address _investor) </span>{
<span class="cstat-no" title="statement not covered" >    bytes32 currentState = database.bytes32Storage(keccak256(abi.encodePacked("currentState")))</span>;
<span class="cstat-no" title="statement not covered" >    require(database.boolStorage(keccak256(abi.encodePacked(currentState, _investor))) || database.boolStorage(keccak256(abi.encodePacked("ignoreStateChanges", _investor))))</span>;
    _;
  }
&nbsp;
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  //                                            Events
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////
&nbsp;
  event LogMYBBurned(address _tokenHolder, address _burningContract, uint _amount);
  event LogFeeAdded(address indexed _contractAddress, bytes4 _methodID, uint _amount);
  event LogTokenAddress(address tokenAddress);
  event Trade(address src, uint amount, address dest, address receiver, uint max, uint minRate, address walletID);
  event EtherReceived(address sender, uint amount);
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Feb 12 2019 19:03:54 GMT-0800 (PST)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
