<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for ownership/TokenGovernance.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">ownership/</a> TokenGovernance.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/28</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/8</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/8</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/37</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.4.24;
&nbsp;
import '../database/Database.sol';
import '../math/SafeMath.sol';
import '../interfaces/ERC20.sol';
&nbsp;
&nbsp;
// @title A contract which allows for token holders to authorize particular functions to be called
// @notice Token holders must lock their tokens against a particular function
// @notice Token holders can unlock their tokens, removing their vote
// @dev An owner has already been initialized when database is deployed
// @author Kyle Dewhurst, MyBit Foundation
contract TokenGovernance {
  using SafeMath for uint256;
&nbsp;
  Database public database;
&nbsp;
  ERC20 public governanceToken;
&nbsp;
&nbsp;
&nbsp;
  // @dev methodID = bytes4(sha3("functionName(parameterType, parameterType)")
  // @dev functionID = sha3(contractAddress, methodID)
  // @dev numVotes is sha3(contractAddress, methodID, sha3(parameter, parameter)))
  // @dev quorumLevel = percentage of tokens required to be locked for the execution of a function
&nbsp;
&nbsp;
  // @notice initiator of the platform sets the initial functions quorum level
  // @notice quorum level dictates the number of votes required for that function to be executed
<span class="fstat-no" title="function not covered" >  constructor(address _database, uint256 _baseQuorum)</span>
  public  {
<span class="cstat-no" title="statement not covered" >    governanceToken = ERC20(database.addressStorage(keccak256(abi.encodePacked("platformToken"))))</span>;
<span class="cstat-no" title="statement not covered" >    database = Database(_database)</span>;
<span class="cstat-no" title="statement not covered" >    governanceToken = ERC20(governanceToken)</span>;
<span class="cstat-no" title="statement not covered" >    bytes4 methodID = bytes4(keccak256(abi.encodePacked("setQuorumLevel(address, bytes4, uint256)")))</span>;
<span class="cstat-no" title="statement not covered" >    bytes32 functionID = keccak256(abi.encodePacked(address(this), methodID))</span>;
    database.setUint(functionID, _baseQuorum);   // the initial quorum level to set further quorum levels
  }
&nbsp;
  // @notice If restricted it will have to be called from address(this) using a voting proccess on signForFunctionCall
<span class="fstat-no" title="function not covered" >  function setQuorumLevel(address _contractAddress, bytes4 _methodID, uint256 _quorumLevel)</span>
  external
  isRestricted(msg.sig, keccak256(abi.encodePacked(_contractAddress, _methodID, _quorumLevel)))
  returns (bool) {
<span class="cstat-no" title="statement not covered" >    bytes32 functionID = keccak256(abi.encodePacked(_contractAddress, _methodID))</span>;
    database.setUint(functionID, _quorumLevel);
<span class="cstat-no" title="statement not covered" >    return true;</span>
  }
&nbsp;
  // @param (bytes32) _parameterHash = The hash of the exact parameter to be called for function...ie sha3(true, 55)
<span class="fstat-no" title="function not covered" >  function voteForExecution(address _contractAddress, bytes4 _methodID, bytes32 _parameterHash, uint256 _voteAmount)</span>
  external
  returns (bool) {
<span class="cstat-no" title="statement not covered" >    bytes32 executionID = keccak256(abi.encodePacked(_contractAddress, _methodID, _parameterHash))</span>;
<span class="cstat-no" title="statement not covered" >    bytes32 numVotesID = keccak256(abi.encodePacked("numberOfVotes", executionID))</span>;
<span class="cstat-no" title="statement not covered" >    require(lockTokens(_voteAmount, executionID))</span>;
<span class="cstat-no" title="statement not covered" >    uint256 numVotes = database.uintStorage(numVotesID)</span>;
    database.setUint(numVotesID, numVotes.add(_voteAmount));
<span class="cstat-no" title="statement not covered" >    return true;</span>
  }
&nbsp;
&nbsp;
<span class="fstat-no" title="function not covered" >  function unlockTokens(bytes32 _executionID)</span>
  external
  returns (bool) {
<span class="cstat-no" title="statement not covered" >    bytes32 voteID = keccak256(abi.encodePacked("tokenVotesLocked", _executionID, msg.sender))</span>;
<span class="cstat-no" title="statement not covered" >    bytes32 numVotesID = keccak256(abi.encodePacked("numberOfVotes", _executionID))</span>;
<span class="cstat-no" title="statement not covered" >    uint256 amountLocked = database.uintStorage(voteID)</span>;
<span class="cstat-no" title="statement not covered" >    uint256 numVotes = database.uintStorage(numVotesID)</span>;
    database.setUint(numVotesID, numVotes.sub(amountLocked));
    governanceToken.transfer(msg.sender, amountLocked);
<span class="cstat-no" title="statement not covered" >    return true;</span>
  }
&nbsp;
&nbsp;
  //------------------------------------------------------------------------------------------------------------------
  //                                                Internal Functions
  //------------------------------------------------------------------------------------------------------------------
&nbsp;
<span class="fstat-no" title="function not covered" >  function lockTokens(uint _amountToLock, bytes32 _executionID)</span>
  internal
  returns (bool) {
<span class="cstat-no" title="statement not covered" >    bytes32 voteID = keccak256(abi.encodePacked("tokenVotesLocked", _executionID, msg.sender))</span>;
<span class="cstat-no" title="statement not covered" >    require(governanceToken.transferFrom(msg.sender, address(this), _amountToLock))</span>;
<span class="cstat-no" title="statement not covered" >    uint256 amountLocked = database.uintStorage(voteID)</span>;
    database.setUint(voteID, amountLocked.add(_amountToLock));
<span class="cstat-no" title="statement not covered" >    return true;</span>
  }
&nbsp;
&nbsp;
  //------------------------------------------------------------------------------------------------------------------
  //                                                View Functions
  //------------------------------------------------------------------------------------------------------------------
&nbsp;
<span class="fstat-no" title="function not covered" >  function isQuorumReached(address _contractAddress, bytes4 _methodID, bytes32 _parameterHash)</span>
  public
  view
  returns (bool) {
<span class="cstat-no" title="statement not covered" >    uint256 quorumLevel = database.uintStorage(keccak256(abi.encodePacked(_contractAddress, _methodID)))</span>;
<span class="cstat-no" title="statement not covered" >    bytes32 executionID = keccak256(abi.encodePacked(_contractAddress, _methodID, _parameterHash))</span>;
<span class="cstat-no" title="statement not covered" >    bytes32 numVotesID = keccak256(abi.encodePacked("numberOfVotes", executionID))</span>;
<span class="cstat-no" title="statement not covered" >    uint256 numTokens = governanceToken.totalSupply()</span>;
    // check that number of signatures are greater than required quorum
<span class="cstat-no" title="statement not covered" >    return database.uintStorage(numVotesID).mul(100).div(numTokens) &gt;= quorumLevel;</span>
  }
&nbsp;
  //------------------------------------------------------------------------------------------------------------------
  //                                                Modifiers
  //------------------------------------------------------------------------------------------------------------------
&nbsp;
&nbsp;
  // @notice add this modifer to functions that you want multi-sig requirements for
  // @dev function can only be called after at least n &gt;= quorumLevel owners have agreed to call it
<span class="fstat-no" title="function not covered" >  modifier isRestricted(bytes4 _methodID, bytes32 _parameterHash) </span>{
<span class="cstat-no" title="statement not covered" >    require(isQuorumReached(address(this), _methodID, _parameterHash))</span>;   // owners must have agreed on function + parameters
    _;
    // remove votes from function call
    database.deleteUint(keccak256(abi.encodePacked(address(this), _methodID, _parameterHash)));
  }
&nbsp;
  // @notice reverts if caller is not the owner
<span class="fstat-no" title="function not covered" >  modifier onlyOwner </span>{
<span class="cstat-no" title="statement not covered" >    require(database.boolStorage(keccak256(abi.encodePacked("owner", msg.sender))) == true)</span>;
    _;
  }
&nbsp;
&nbsp;
  //------------------------------------------------------------------------------------------------------------------
  //                                              Events
  //------------------------------------------------------------------------------------------------------------------
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Oct 31 2018 14:33:22 GMT-0700 (PDT)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
